{% extends "layout.html" %}

{% block content %}
<div class="dashboard-section">
  {% if not token_present %}
  <!-- Setup Card -->
  <div class="card-wrapper-centered">
    <div class="card card-compact">
      <h2>üîê Configuration Setup</h2>
      <div class="card-content">
        <p class="info-text">Enter your Cloudflare API token to get started.</p>
        <form hx-post="/api/config" method="post" class="stacked-form">
          <div class="form-group">
            <input type="password" name="token" placeholder="Paste your Cloudflare API token..." required />
          </div>
          <button type="submit">Save Token</button>
        </form>
      </div>
    </div>
  </div>

  {% else %}
  <!-- Import Records Card - Full Width -->
  <div class="card">
    <h2>üì• Import Records</h2>
    <div class="card-content">
      <button type="button" class="btn-block"
        onclick="openZonesModal()"
        hx-get="/api/zones"
        hx-target="#zones-modal-body"
        hx-swap="innerHTML">
        Load Zones from Cloudflare
      </button>
    </div>
  </div>

  <div id="zones-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="zones-modal-title" tabindex="-1">
      <div class="modal-header">
        <h3 id="zones-modal-title">Import Cloudflare Records</h3>
        <button type="button" class="modal-close" aria-label="Close import modal" onclick="closeZonesModal()">&times;</button>
      </div>
      <div id="zones-modal-body" class="modal-body">
        <p class="info-text">Click "Load Zones from Cloudflare" to retrieve your available zones.</p>
      </div>
    </div>
  </div>

  <!-- Records Table Card -->
  <div class="card full-span">
    <div class="card-header">
      <h2 style="margin: 0;">üìã Configured Records</h2>
      <button hx-post="/api/update-now" hx-swap="none" onclick="handleSync()">üöÄ Sync Now</button>
    </div>
    {% if records %}
    <div class="table-wrapper">
      <table class="records-table">
        <thead>
          <tr>
            <th>Domain Name</th>
            <th>Type</th>
            <th>IP Address</th>
            <th style="text-align: center;">Proxy</th>
            <th style="text-align: center;">Auto-Update</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="records-body">
          {% for r in records %}
          <tr>
            <td><strong>{{ r.name }}</strong></td>
            <td><span class="badge badge-success">{{ r.type or 'A' }}</span></td>
            <td><code>{{ r.content }}</code></td>
            <td style="text-align: center;">
              <input type="checkbox" class="proxy-checkbox" data-record-id="{{ r.record_id }}" disabled
                title="Loading proxy status..." />
            </td>
            <td style="text-align: center;">
              <input type="checkbox" {% if r.auto_update %}checked{% endif %}
                onchange="updateAutoFlag('{{ r.record_id }}', this.checked)" />
            </td>
            <td>
              <button onclick="deleteRecord('{{ r.record_id }}')" class="btn-danger btn-small">Delete</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">
      <p>üì≠ No records configured yet</p>
      <p>Load zones and import records to get started.</p>
    </div>
    {% endif %}
  </div>

  {% endif %}
</div>

<script>
  const zonesModal = document.getElementById('zones-modal');
  const zonesModalBody = document.getElementById('zones-modal-body');

  function openZonesModal() {
    if (!zonesModal) return;
    zonesModal.classList.add('is-visible');
    zonesModal.setAttribute('aria-hidden', 'false');
    zonesModalBody?.scrollTo({ top: 0 });
    const dialog = zonesModal.querySelector('.modal-dialog');
    if (dialog) {
      dialog.focus();
    }
  }

  function closeZonesModal() {
    if (!zonesModal) return;
    zonesModal.classList.remove('is-visible');
    zonesModal.setAttribute('aria-hidden', 'true');
  }

  if (zonesModal) {
    zonesModal.addEventListener('click', function (evt) {
      if (evt.target === zonesModal) {
        closeZonesModal();
      }
    });
  }

  document.addEventListener('keydown', function (evt) {
    if (evt.key === 'Escape' && zonesModal?.classList.contains('is-visible')) {
      closeZonesModal();
    }
  });

  function handleSync() {
    alert('üöÄ Sync initiated. Check back in a moment for results.');
  }

  function updateAutoFlag(recordId, checked) {
    fetch('/api/records?record_id=' + encodeURIComponent(recordId) + '&auto_update=' + checked, { method: 'PATCH' })
      .then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .catch(e => {
        alert('‚ùå Failed to update: ' + e.message);
        location.reload();
      });
  }

  function deleteRecord(recordId) {
    if (!confirm('Are you sure you want to delete this record? This cannot be undone.')) return;
    fetch('/api/records?id=' + encodeURIComponent(recordId), { method: 'DELETE' })
      .then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .then(data => {
        location.reload();
      })
      .catch(e => {
        alert('‚ùå Failed to delete: ' + e.message);
      });
  }

  // Render zones and create record load buttons in modal
  document.body.addEventListener('htmx:afterSwap', function (evt) {
    if (evt.detail.target.id === 'zones-modal-body') {
      try {
        const response = JSON.parse(evt.detail.xhr.response);
        const zones = response || [];
        const target = document.getElementById('zones-modal-body');
        if (!target) return;
        if (zones.length === 0) {
          target.innerHTML = '<p class="info-text">No zones found.</p>';
          return;
        }
        let html = '';
        zones.forEach(zone => {
          html += `
            <div class="zone-item">
              <div class="zone-header">
                <div>
                  <strong>${zone.name}</strong><br>
                  <small class="zone-meta">${zone.id}</small>
                </div>
                <button onclick="loadRecords('${zone.id}')" class="btn-small">Load Records</button>
              </div>
              <div id="records-${zone.id}" class="zone-records"></div>
            </div>
          `;
        });
        target.innerHTML = html;
      } catch (e) {
        const target = document.getElementById('zones-modal-body');
        if (target) target.innerHTML = '<p class="error-text">Error loading zones: ' + e.message + '</p>';
        console.error('Zones parse error:', e);
      }
    }
  });

  function loadRecords(zoneId) {
    const target = document.getElementById('records-' + zoneId);
    if (!target) return;
    target.innerHTML = '<p class="info-text"><span class="loading">‚è≥</span> Loading records...</p>';

    fetch('/api/zones/' + zoneId + '/records')
      .then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .then(data => {
        const records = data.records || [];
        let html = '';
        if (records.length === 0) {
          html = '<p class="info-text">No A/AAAA records found.</p>';
        } else {
          html += '<div class="table-wrapper"><table class="mini-table"><tr>'
            + '<th><input type="checkbox" id="select-all-' + zoneId + '" onchange="selectAll(this, \'' + zoneId + '\')"></th>'
            + '<th>Name</th><th>Type</th><th>IP</th></tr>';
          records.forEach(rec => {
            html += `<tr>
              <td><input type="checkbox" class="record-checkbox-${zoneId}" data-record-id="${rec.id}"></td>
              <td>${rec.name}</td>
              <td><span class="badge badge-success">${rec.type}</span></td>
              <td><code>${rec.content}</code></td>
            </tr>`;
          });
          html += '</table></div>';
          html += '<button onclick="importSelected(\'' + zoneId + '\')" class="btn-block">Import Selected Records</button>';
        }
        target.innerHTML = html;
      })
      .catch(e => {
        target.innerHTML = '<p class="error-text">Error: ' + e.message + '</p>';
        console.error('Load records error:', e);
      });
  }

  function selectAll(checkbox, zoneId) {
    const checkboxes = document.querySelectorAll('.record-checkbox-' + zoneId);
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
  }

  function importSelected(zoneId) {
    const checkboxes = document.querySelectorAll('.record-checkbox-' + zoneId + ':checked');
    const recordIds = Array.from(checkboxes).map(cb => cb.dataset.recordId);

    if (recordIds.length === 0) {
      alert('Please select at least one record to import.');
      return;
    }

    fetch('/api/import-records', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ zone_id: zoneId, record_ids: recordIds })
    })
      .then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .then(data => {
        alert('‚úÖ Imported ' + data.imported + ' record(s). Refreshing...');
        location.reload();
      })
      .catch(e => {
        alert('‚ùå Import failed: ' + e.message);
        console.error('Import error:', e);
      });
  }

  // Sort records table by name on page load
  window.addEventListener('load', function () {
    sortRecordsTable();
    loadProxyStatuses();
  });

  function sortRecordsTable() {
    const tbody = document.getElementById('records-body');
    if (!tbody) return;

    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((a, b) => {
      const aName = a.cells[0]?.textContent.trim() || '';
      const bName = b.cells[0]?.textContent.trim() || '';
      return aName.localeCompare(bName);
    });

    rows.forEach(row => tbody.appendChild(row));
  }

  function loadProxyStatuses() {
    const checkboxes = document.querySelectorAll('.proxy-checkbox');
    checkboxes.forEach(checkbox => {
      const recordId = checkbox.dataset.recordId;
      fetch('/api/records/' + encodeURIComponent(recordId) + '/proxy')
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .then(data => {
          checkbox.checked = data.proxied;
          checkbox.disabled = false;
          checkbox.title = 'Toggle proxy (orange cloud) status';
          checkbox.onchange = function () {
            updateProxyStatus(recordId, this.checked);
          };
        })
        .catch(e => {
          console.error('Failed to load proxy status:', e);
          checkbox.title = 'Error loading proxy status';
        });
    });
  }

  function updateProxyStatus(recordId, proxied) {
    fetch('/api/records/' + encodeURIComponent(recordId) + '/proxy?proxied=' + proxied, { method: 'PATCH' })
      .then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .then(data => {
        console.log('Proxy updated:', recordId, proxied);
      })
      .catch(e => {
        alert('‚ùå Failed to update proxy: ' + e.message);
        loadProxyStatuses();
      });
  }
</script>
{% endblock %}
